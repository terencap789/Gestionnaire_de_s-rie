<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestionnaire d'Épisodes</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Gestionnaire d'Épisodes</h1>
    <div class="container">
        <label for="serieName">Nom de la série :</label>
        <input type="text" id="serieName" placeholder="ex: Breaking Bad">

        <button onclick="createSerie()">Créer la série</button>

        <hr>

        <label for="serieSelect">Sélectionner une série :</label>
        <select id="serieSelect">
            <option value="">-- Choisir --</option>
        </select>

        <label for="seasonNumber">Saison :</label>
        <input type="number" id="seasonNumber" min="1">

        <label for="episodeNumber">Épisode :</label>
        <input type="number" id="episodeNumber" min="1">

        <label for="watchDate">Date de visionnage :</label>
        <input type="date" id="watchDate">

        <label for="note">Note ou commentaire :</label>
        <textarea id="note" placeholder="Note (optionnel)"></textarea>

        <button onclick="addEpisode()">Ajouter un épisode</button>
        <button onclick="viewEpisodes()">Afficher tous les épisodes</button>
        <button onclick="deleteEpisode()">Supprimer un épisode</button>
        <button onclick="deleteSerie()">Supprimer la série</button>
        <button onclick="searchSeason()">Rechercher par saison</button>

        <hr>

        <button onclick="exportData()">Exporter (JSON chiffré)</button>
        <input type="file" onchange="importData(event)">

        <div class="episode-list" id="episodeList"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        let series = {};
        let secretKey = generateKey();

        function generateKey() {
            return CryptoJS.lib.WordArray.random(16).toString();
        }

        function clearFields() {
            document.getElementById("seasonNumber").value = "";
            document.getElementById("episodeNumber").value = "";
            document.getElementById("watchDate").value = "";
            document.getElementById("note").value = "";
        }

        function createSerie() {
            const name = document.getElementById("serieName").value.trim();
            if (name && !series[name]) {
                series[name] = [];
                const option = new Option(name, name);
                document.getElementById("serieSelect").add(option);
                alert(`Série "${name}" créée.`);
            }
            document.getElementById("serieName").value = "";
        }

        function addEpisode() {
            const serie = document.getElementById("serieSelect").value;
            const saison = document.getElementById("seasonNumber").value;
            const episode = document.getElementById("episodeNumber").value;
            const date = document.getElementById("watchDate").value;
            const note = document.getElementById("note").value;

            if (serie && saison && episode && date) {
                series[serie].push({ saison, episode, date, note });
                alert("Épisode ajouté.");
                clearFields();
            } else {
                alert("Remplis tous les champs obligatoires.");
            }
        }

        function viewEpisodes() {
            const serie = document.getElementById("serieSelect").value;
            const list = document.getElementById("episodeList");
            list.innerHTML = "";

            if (serie && series[serie].length) {
                series[serie].forEach(ep => {
                    list.innerHTML += `Saison ${ep.saison}, Épisode ${ep.episode}<br>Date: ${ep.date}<br>Note: ${ep.note || "Aucune"}<hr>`;
                });
            } else {
                list.innerHTML = "Aucun épisode enregistré.";
            }
            clearFields();
        }

        function deleteEpisode() {
            const serie = document.getElementById("serieSelect").value;
            const saison = document.getElementById("seasonNumber").value;
            const episode = document.getElementById("episodeNumber").value;

            if (serie && saison && episode) {
                series[serie] = series[serie].filter(ep => !(ep.saison == saison && ep.episode == episode));
                alert("Épisode supprimé.");
                clearFields();
            } else {
                alert("Saisis la saison et l'épisode à supprimer.");
            }
        }

        function deleteSerie() {
            const select = document.getElementById("serieSelect");
            const serie = select.value;
            if (serie && confirm("Confirmer la suppression de la série ?")) {
                delete series[serie];
                select.remove(select.selectedIndex);
                alert("Série supprimée.");
                document.getElementById("episodeList").innerHTML = "";
            }
            clearFields();
        }

        function searchSeason() {
            const serie = document.getElementById("serieSelect").value;
            const saison = document.getElementById("seasonNumber").value;
            const list = document.getElementById("episodeList");
            list.innerHTML = "";

            if (serie && saison) {
                const results = series[serie].filter(ep => ep.saison == saison);
                if (results.length) {
                    results.forEach(ep => {
                        list.innerHTML += `Saison ${ep.saison}, Épisode ${ep.episode}<br>Date: ${ep.date}<br>Note: ${ep.note || "Aucune"}<hr>`;
                    });
                } else {
                    list.innerHTML = "Aucun épisode trouvé pour cette saison.";
                }
            }
            clearFields();
        }

        function exportData() {
            const data = JSON.stringify({ series, key: secretKey });
            const encrypted = CryptoJS.AES.encrypt(data, secretKey).toString();
            const blob = new Blob([encrypted], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "episodes_chiffres.json";
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const encrypted = e.target.result;
                    const decrypted = CryptoJS.AES.decrypt(encrypted, secretKey).toString(CryptoJS.enc.Utf8);
                    const parsed = JSON.parse(decrypted);
                    if (parsed.series && parsed.key) {
                        series = parsed.series;
                        secretKey = parsed.key;

                        const select = document.getElementById("serieSelect");
                        select.innerHTML = '<option value="">-- Choisir --</option>';
                        Object.keys(series).forEach(name => {
                            const option = new Option(name, name);
                            select.add(option);
                        });

                        alert("Importation réussie.");
                        viewEpisodes();
                    } else {
                        throw new Error("Structure JSON invalide.");
                    }
                } catch (err) {
                    alert("Erreur lors du déchiffrement ou du parsing : " + err.message);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
